# `p5.js`阅读笔记

## 各函数及其作用

下文中的“合约”如无特殊指代，均指`StoreTraffic.sol`。

| 函数名 | 作用简述 |
| --- | --- |
| manageVehicleByRegion5 | 对于给定的乘客账户和Geohash地址，对其调用`passengerUnit()`方法 |
| passengerUnit | 调用了合约中的`initPassenger()`方法，以在合约中记录其id（其实就是公钥地址）和当前乘客位置；接下来，调用合约的`setPassengerDemand()`方法设置该乘客的起点终点信息；接下来，收集起点及其周边地块，调用`regionTask()`方法；待所有区块全部经过`regionTask()`方法处理后，调用`getVehicleByRegion()`方法开始调度车辆 |
| regionTask | 其调用了魔改版`web3`的`getAccountByRegion()`方法，获得给定位置中滞留了一定时间的账户的公钥，以`regionVehicles`参数的形式传出计算结果 |
| getVehicleByRegion | 调用合约中的同名函数，在所有符合条件的车中找到和乘客的曼哈顿距离最短的一辆车，得到二元组`(车辆位置, 车辆公钥地址)`；随后，调用合约中的`setVehicleStatus()`方法，将该车的状态设置为1（原本是0,表示空闲，若状态为1，则表示已被占用），合约中随之发射一个`Myevent`事件（会被`vehicle.js`捕获，然后开始派遣司机前往）；然后`getDistanceByGeohash()`被调用来计算起止地点距离（细节略过，应该和GeoHash关系较大）；随后，配合`isboard`变量和`trafficContract.events.routeEvent`事件，判断乘客是上车还是下车；若上车，调用合约的`confirmBoard()`方法；否则，调用自己的`getOff()`方法，把乘客踢下车 |
| getOff| 简简单单调用合约的`confirmPay()`方法完成支付 |